# Implementation Plan: Script Debug API

**Branch**: `010-script-debug-api` | **Date**: 2025-11-03 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/010-script-debug-api/spec.md`

## Summary

Add script debugging API endpoint that allows users to test custom calculation scripts against a single stock symbol, providing detailed execution logs, intermediate values, and error diagnostics. Supports both inline script code and script ID references.

**Technical Approach**: Create new debug endpoint at `POST /api/custom-calculations/debug` that accepts (script code OR script_id) + symbol + optional mock data, enhances SandboxExecutor with verbose logging mode, returns detailed execution trace with variable values and timing.

## Technical Context

**Language/Version**: Python 3.11+  
**Primary Dependencies**: Flask 3.x, SQLAlchemy 2.0+, RestrictedPython 6.0+  
**Storage**: PostgreSQL with TimescaleDB  
**Testing**: pytest, manual curl testing  
**Target Platform**: Linux server, Web application  
**Project Type**: Web application (single Flask app)  
**Performance Goals**: Debug response < 5 seconds, detailed logs capture all execution steps  
**Constraints**: Same security sandbox as production, single-stock execution only, verbose logging without performance impact on production  
**Scale/Scope**: Support debugging any uploaded script, handle scripts with 100+ lines, log up to 1000 execution steps

## Constitution Check

*Re-evaluated after Phase 1 design*

- **I. Direct Development on Main**: ⚠️ PENDING - Will switch to main for implementation  
- **II. Complete Before Commit**: ✅ PASS - Debug API will be fully implemented before commit  
- **III. Incremental Commits**: ✅ PASS - Each feature (debug endpoint, verbose logging, mock data) committed independently  
- **IV. Test Before Push**: ⚠️ PENDING - Manual testing will be performed  
- **V. Documentation Integrity**: ✅ PASS - API contracts will be created  
- **VI. API Contract Compliance**: ✅ PASS - Response format will match contracts

## Project Structure

### Documentation (this feature)

```text
specs/010-script-debug-api/
├── plan.md              # This file
├── research.md          # Phase 0 output
├── data-model.md        # Phase 1 output
├── quickstart.md        # Phase 1 output
├── contracts/
│   └── api-contracts.json  # Phase 1 output
└── tasks.md             # Phase 2 output (/speckit.tasks)
```

### Source Code (repository root)

```text
app/
├── routes/
│   └── custom_calculation.py  # Modify: Add debug endpoint
├── services/
│   └── sandbox_executor.py    # Modify: Add verbose logging mode
└── models/
    └── custom_script.py       # No changes (already supports script loading)

tests/
└── test_script_debug.py       # New: Debug API tests
```

**Structure Decision**: Single Flask web application. Add new debug endpoint to existing custom_calculation routes, enhance sandbox executor with logging capabilities.

## Complexity Tracking

> **No violations - debug endpoint is additive feature**

## Phase Status

- [x] Phase 0 (Research): COMPLETE ✅
- [x] Phase 1 (Design): COMPLETE ✅
- [ ] Phase 2 (Tasks): To be generated by `/speckit.tasks`

## Next Steps

1. **Phase 0**: Research verbose logging patterns for RestrictedPython execution
2. **Phase 1**: Generate API contracts, data model, quickstart guide
3. **Phase 2**: Generate implementation tasks
4. **Implementation**: Add debug endpoint, enhance logging, test
