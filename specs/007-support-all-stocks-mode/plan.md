# Implementation Plan: Support All-Stocks Mode for Custom Calculations

**Branch**: `007-support-all-stocks-mode` | **Date**: 2025-01-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/007-support-all-stocks-mode/spec.md`

**Note**: This template is filled in by the `/speckit.plan` command. See `.specify/templates/commands/plan.md` for the execution workflow.

## Summary

Support applying custom calculation scripts to all active stocks without requiring the stock_symbols array. When stock_symbols is empty or missing, the API automatically fetches all active stocks from the database and applies the script to each stock. This requires: 1) Modifying validation to allow empty stock_symbols array, 2) Fetching all active stocks from database when array is empty, 3) Batching execution to prevent timeout for large stock universes, 4) Maintaining backward compatibility with specific stock symbols.

## Technical Context

**Language/Version**: Python 3.11+  
**Primary Dependencies**: Flask 3.x, SQLAlchemy 2.0+, RestrictedPython 6.0+, psycopg2-binary 2.9+  
**Storage**: PostgreSQL with TimescaleDB for historical stock data  
**Testing**: pytest (manual API testing)  
**Target Platform**: Linux server (Rocky Linux 9)  
**Project Type**: Web application (Flask backend)  
**Performance Goals**: All-stocks execution < 60 seconds for 1000 stocks, API response time < 3 seconds per batch  
**Constraints**: Must maintain backward compatibility, handle large stock universes without timeout, graceful error handling  
**Scale/Scope**: Support 1000+ active stocks, batch processing to prevent timeout, maintain existing API contract

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### I. Direct Development on Main
✅ **PASS**: Will develop on main branch per constitution requirement.

### II. Complete Before Commit
✅ **PASS**: Implementation will be complete feature before committing.

### III. Incremental Commits
✅ **PASS**: Will commit as independent feature increment.

### IV. Test Before Push
⚠️ **NEEDS ATTENTION**: Must ensure:
- API handles empty stock_symbols correctly
- All-stocks execution works with 1000+ stocks
- Backward compatibility maintained
- Error handling works correctly

### V. Documentation Integrity
✅ **PASS**: Will update API documentation for all-stocks mode, comments in code.

### VI. API Contract Compliance
✅ **PASS**: Extends existing API contract to support empty stock_symbols array.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/speckit.plan command output)
├── research.md          # Phase 0 output (/speckit.plan command)
├── data-model.md        # Phase 1 output (/speckit.plan command)
├── quickstart.md        # Phase 1 output (/speckit.plan command)
├── contracts/           # Phase 1 output (/speckit.plan command)
└── tasks.md             # Phase 2 output (/speckit.tasks command - NOT created by /speckit.plan)
```

### Source Code (repository root)

Flask Web Application:

```text
app/
├── routes/
│   └── custom_calculation.py      # Script execution endpoints (NEEDS MODIFICATION)
├── services/
│   ├── sandbox_executor.py        # Sandbox executor (existing)
│   └── stock_data_service.py     # Stock data service (NEEDS ENHANCEMENT)
└── utils/
    └── responses.py                # Response formatting

models/
└── stock_data.py                   # StockDailyData model (existing)

database/
├── connection.py                   # DB manager (existing)
└── migrations/
```

**Structure Decision**: Flask application with custom calculation API. Main modifications needed in `app/routes/custom_calculation.py` to support empty stock_symbols array and fetch all active stocks from database.

**Key Files to Modify**:
- `app/routes/custom_calculation.py` - Modify execute_script endpoint to support empty stock_symbols
- `app/services/stock_data_service.py` - Add method to fetch all active stocks
- No new files needed, just enhancements to existing API

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

No violations detected. Implementation extends existing API with minimal changes.

## Phase Status

### Phase 0: Research ✅ COMPLETE
- ✅ Generated `research.md` with implementation strategies
- ✅ Resolved all technical unknowns
- ✅ Decisions: Empty array handling, all-stocks fetching, backward compatibility

### Phase 1: Design ✅ COMPLETE
- ✅ Generated `data-model.md` with data flow details
- ✅ Generated `contracts/api-contracts.json` with API spec
- ✅ Generated `quickstart.md` with implementation guide
- ✅ Updated agent context files

### Phase 2: Tasks (TODO)
- Implementation tasks will be generated by `/speckit.tasks` command
- Not part of this planning phase

## Post-Design Constitution Check

**Re-evaluation after Phase 1 design completion:**

### I. Direct Development on Main
✅ **PASS**: Will develop on main branch per constitution requirement.

### II. Complete Before Commit
✅ **PASS**: Implementation will be complete feature before committing.

### III. Incremental Commits
✅ **PASS**: Will commit as independent feature increment.

### IV. Test Before Push
✅ **PASS**: Test plan documented in quickstart.md:
- Manual API testing with empty array
- Backward compatibility testing
- Error handling verification
- Performance testing

### V. Documentation Integrity
✅ **PASS**: All documentation generated (spec, plan, research, data-model, contracts, quickstart).

### VI. API Contract Compliance
✅ **PASS**: API extends existing contract to support empty stock_symbols array, maintains backward compatibility.

## Next Steps

1. **Switch to main branch** per Constitution requirement
2. **Run `/speckit.tasks`** to generate implementation tasks
3. **Implement service method** (add get_all_active_stocks to stock_data_service.py)
4. **Modify API endpoint** (update execute_script to handle empty array)
5. **Test thoroughly** per validation checklist
6. **Commit and push** after successful testing
